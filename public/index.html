<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgN - Sistema de Numeração</title>
    <style>
        :root { --primary: #0056b3; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: var(--primary); text-align: center; margin-bottom: 30px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; transition: 0.3s; }
        button:hover { background: #004494; }
        .hidden { display: none; }
        
        /* Tabela de Histórico */
        .history { margin-top: 40px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; color: #555; }
        .badge-num { background: var(--primary); color: white; padding: 4px 8px; border-radius: 12px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>AgN <small style="font-size: 0.5em; color: #666;">Numeração AgSUS</small></h1>

    <form id="formAgN">
        <!-- Seleção do Tipo (Dispara a lógica visual) -->
        <div class="form-group">
            <label>Tipo de Documento *</label>
            <select id="tipo" name="tipo" required onchange="ajustarCampos()">
                <option value="">Selecione...</option>
                <option value="Cotação de Preços">Cotação de Preços</option>
                <option value="Pregão Eletrônico">Pregão Eletrônico</option>
                <option value="Ata SRP">Ata SRP</option>
                <option value="Credenciamento">Credenciamento</option>
                <option value="Convênio">Convênio</option>
                <option value="Ordem de Fornecimento">Ordem de Fornecimento</option>
                <option value="Contratos">Contratos</option>
                <option value="Inexigibilidade">Inexigibilidade</option>
                <option value="Contrato de Patrocínio">Contrato de Patrocínio</option>
                <option value="Acordo de Cooperação">Acordo de Cooperação</option>
            </select>
        </div>

        <!-- Campos Comuns (Sempre visíveis) -->
        <div class="form-group">
            <label>Data</label>
            <input type="date" id="data" name="data" required>
        </div>

        <div class="form-group">
            <label>Processo (ex: AGSUS.007637/2025-93) *</label>
            <input type="text" name="processo" required placeholder="Número do Processo SEI">
        </div>

        <div class="form-group">
            <label>Objeto *</label>
            <textarea name="objeto" rows="3" required placeholder="Descrição do objeto..."></textarea>
        </div>

        <div class="form-group">
            <label>Drive ID (Opcional)</label>
            <input type="number" name="drive" placeholder="Ex: 375">
        </div>

        <!-- Campos Específicos (Controlados via JS) -->
        
        <!-- Grupo: Publicação -->
        <div id="group-publicacao" class="hidden">
            <div class="form-group">
                <label>Publicado no site AgSUS?</label>
                <select name="publicado_site">
                    <option value="Não">Não</option>
                    <option value="Sim">Sim</option>
                </select>
            </div>
        </div>

        <!-- Campo: Divulgação (Só Cotação) -->
        <div id="field-divulgacao" class="form-group hidden">
            <label>Divulgação da Cotação</label>
            <select name="divulgacao_cotacao">
                <option value="">Selecione...</option>
                <option value="E-Mail">E-Mail</option>
                <option value="Compras Gov">Compras Gov</option>
            </select>
        </div>

        <!-- Campo: Contratado (Só Ata SRP) -->
        <div id="field-contratado" class="form-group hidden">
            <label>Contratado *</label>
            <input type="text" name="contratado">
        </div>

        <!-- Campo: Coordenação (Vários) -->
        <div id="field-coordenacao" class="form-group hidden">
            <label>Coordenação</label>
            <input type="text" name="coordenacao">
        </div>

        <!-- Campo: Orçamento (Credenciamento/Convênio) -->
        <div id="field-orcamento" class="form-group hidden">
            <label>Orçamento</label>
            <input type="text" name="orcamento">
        </div>

        <div class="form-group">
            <label>Observações</label>
            <textarea name="observacoes" rows="2"></textarea>
        </div>

        <button type="submit">Gerar Número</button>
    </form>

    <div class="history">
        <h3>Últimos Gerados</h3>
        <table id="tabelaHistorico">
            <thead>
                <tr>
                    <th>Número</th>
                    <th>Tipo</th>
                    <th>Processo</th>
                    <th>Objeto</th>
                </tr>
            </thead>
            <tbody><!-- JS preenche aqui --></tbody>
        </table>
    </div>
</div>

<script>
    // 1. Configura Data de Hoje ao abrir
    document.getElementById('data').valueAsDate = new Date();

    // 2. Lógica de Exibição de Campos
    function ajustarCampos() {
        const tipo = document.getElementById('tipo').value;
        
        // Reseta visibilidade
        document.getElementById('group-publicacao').classList.add('hidden');
        document.getElementById('field-divulgacao').classList.add('hidden');
        document.getElementById('field-contratado').classList.add('hidden');
        document.getElementById('field-coordenacao').classList.add('hidden');
        document.getElementById('field-orcamento').classList.add('hidden');

        // Configurações por Tipo
        if (tipo === 'Cotação de Preços') {
            document.getElementById('group-publicacao').classList.remove('hidden');
            document.getElementById('field-divulgacao').classList.remove('hidden');
        } 
        else if (tipo === 'Pregão Eletrônico') {
            document.getElementById('group-publicacao').classList.remove('hidden');
        }
        else if (tipo === 'Ata SRP') {
            document.getElementById('field-contratado').classList.remove('hidden');
            document.getElementById('field-coordenacao').classList.remove('hidden');
            // Torna obrigatório via JS se necessário
        }
        else if (tipo === 'Credenciamento' || tipo === 'Convênio') {
            document.getElementById('group-publicacao').classList.remove('hidden');
            document.getElementById('field-orcamento').classList.remove('hidden');
        }
        else if (['Ordem de Fornecimento', 'Contratos', 'Inexigibilidade', 'Contrato de Patrocínio', 'Acordo de Cooperação'].includes(tipo)) {
            document.getElementById('field-coordenacao').classList.remove('hidden');
        }
    }

    // 3. Envio do Formulário
    document.getElementById('formAgN').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const dados = Object.fromEntries(formData.entries());

        const btn = e.target.querySelector('button');
        btn.disabled = true; btn.innerText = "Gerando...";

        try {
            const resp = await fetch('/api/gerar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            });
            const json = await resp.json();

            if (json.sucesso) {
                alert(`Gerado com Sucesso!\n\n${json.dados.tipo}\nNÚMERO: ${json.dados.numero}/${json.dados.ano}`);
                e.target.reset();
                document.getElementById('data').valueAsDate = new Date();
                ajustarCampos();
                carregarHistorico();
            } else {
                alert('Erro: ' + json.erro);
            }
        } catch (err) {
            alert('Erro de conexão.');
        }
        btn.disabled = false; btn.innerText = "Gerar Número";
    });

    // 4. Carregar Histórico
    async function carregarHistorico() {
        const resp = await fetch('/api/listar');
        const lista = await resp.json();
        const tbody = document.querySelector('#tabelaHistorico tbody');
        tbody.innerHTML = '';
        
        lista.forEach(item => {
            tbody.innerHTML += `
                <tr>
                    <td><span class="badge-num">${item.numero}/${item.ano}</span></td>
                    <td>${item.tipo}</td>
                    <td>${item.processo || '-'}</td>
                    <td>${item.objeto}</td>
                </tr>
            `;
        });
    }
    
    // Carrega ao iniciar
    carregarHistorico();
</script>

</body>
</html>
